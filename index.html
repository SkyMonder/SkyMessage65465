<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMessage (Supabase)</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Базовые стили (сокращено для читаемости, можно оставить как есть) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 1200px; height: 90vh; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 8px 30px rgba(0,0,0,0.08); display: flex; }
        .auth-container { display: flex; width: 100%; height: 100%; }
        .auth-form { flex: 1; padding: 40px; display: flex; flex-direction: column; justify-content: center; }
        .auth-illustration { flex: 1; background: linear-gradient(to bottom right, #4361ee, #7209b7); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; color: white; }
        .logo { display: flex; align-items: center; margin-bottom: 30px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #4361ee, #7209b7); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; font-size: 1.8rem; }
        .logo-text { font-size: 2rem; font-weight: 700; background: linear-gradient(to right, #4361ee, #7209b7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .form-title { font-size: 2rem; margin-bottom: 10px; }
        .form-subtitle { color: #6c757d; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem; transition: 0.3s; }
        .form-input:focus { outline: none; border-color: #4361ee; }
        .btn { padding: 14px 20px; border-radius: 10px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: #4361ee; color: white; width: 100%; }
        .btn-primary:hover { background: #3a56d4; transform: translateY(-2px); }
        .btn-secondary { background: #f8f9fa; color: #212529; border: 1px solid #e0e0e0; }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }
        .toggle-form { text-align: center; margin-top: 20px; color: #6c757d; }
        .toggle-form a { color: #4361ee; text-decoration: none; font-weight: 600; cursor: pointer; }
        .error-message { color: #f72585; font-size: 0.9rem; margin-top: 5px; display: none; }
        .main-container { display: none; width: 100%; height: 100%; }
        .sidebar { width: 350px; background: #f8f9fa; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; overflow: hidden; }
        .user-info { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; background: white; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #4361ee, #7209b7); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.2rem; margin-right: 15px; }
        .search-container { padding: 20px; background: white; border-bottom: 1px solid #e0e0e0; }
        .search-box { position: relative; }
        .search-box input { width: 100%; padding: 12px 16px 12px 40px; border: 1px solid #e0e0e0; border-radius: 10px; background: #f8f9fa; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #6c757d; }
        .contacts-container { flex: 1; overflow-y: auto; padding: 10px; }
        .contact { display: flex; align-items: center; padding: 15px; border-radius: 10px; cursor: pointer; transition: 0.3s; margin-bottom: 5px; }
        .contact:hover { background: #e9ecef; }
        .contact.active { background: #e3f2fd; }
        .contact-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #4cc9f0, #4361ee); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 15px; }
        .contact-info h4 { font-size: 1rem; margin-bottom: 5px; }
        .contact-info p { color: #6c757d; font-size: 0.85rem; }
        .contact-status { margin-left: auto; width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .contact-status.online { background: #4caf50; }
        .chat-container { flex: 1; display: flex; flex-direction: column; background: white; }
        .chat-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; background: white; }
        .chat-user-info { display: flex; align-items: center; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; background: #f8f9fa; display: flex; flex-direction: column; }
        .message { max-width: 70%; padding: 12px 16px; border-radius: 18px; margin-bottom: 15px; word-wrap: break-word; }
        .message-outgoing { align-self: flex-end; background: #4361ee; color: white; border-bottom-right-radius: 5px; }
        .message-incoming { align-self: flex-start; background: white; color: #212529; border-bottom-left-radius: 5px; border: 1px solid #e0e0e0; }
        .message-time { font-size: 0.75rem; margin-top: 5px; opacity: 0.8; text-align: right; }
        .message-input-container { padding: 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; background: white; }
        .message-input { flex: 1; padding: 14px 16px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 1rem; resize: none; max-height: 100px; }
        .send-button { width: 50px; height: 50px; border-radius: 50%; background: #4361ee; color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; }
        .send-button:hover { background: #3a56d4; transform: scale(1.05); }
        .notification { position: fixed; bottom: 20px; right: 20px; background: white; border-radius: 10px; padding: 15px 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 15px; z-index: 100; transform: translateX(150%); transition: transform 0.3s; max-width: 350px; }
        .notification.show { transform: translateX(0); }
        .notification-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
        .notification.message .notification-icon { background: #4cc9f0; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="container" id="appContainer">
        <!-- Авторизация -->
        <div class="auth-container" id="authContainer">
            <div class="auth-form">
                <div class="logo"><div class="logo-icon"><i class="fas fa-comments"></i></div><div class="logo-text">SkyMessage</div></div>
                <h2 class="form-title" id="formTitle">Войдите в аккаунт</h2>
                <p class="form-subtitle" id="formSubtitle">Введите свои данные для входа</p>
                <form id="loginForm">
                    <div class="form-group"><label class="form-label">Имя пользователя</label><input type="text" class="form-input" id="loginUsername" required><div class="error-message" id="loginUsernameError">Ошибка</div></div>
                    <div class="form-group"><label class="form-label">Пароль</label><input type="password" class="form-input" id="loginPassword" required><div class="error-message" id="loginPasswordError">Ошибка</div></div>
                    <button type="submit" class="btn btn-primary" id="loginButton"><i class="fas fa-sign-in-alt"></i> Войти</button>
                </form>
                <form id="registerForm" class="hidden">
                    <div class="form-group"><label class="form-label">Имя пользователя</label><input type="text" class="form-input" id="registerUsername" required minlength="3"><div class="error-message" id="registerUsernameError">Ошибка</div></div>
                    <div class="form-group"><label class="form-label">Пароль</label><input type="password" class="form-input" id="registerPassword" required minlength="6"><div class="error-message" id="registerPasswordError">Ошибка</div></div>
                    <div class="form-group"><label class="form-label">Подтверждение</label><input type="password" class="form-input" id="registerConfirmPassword" required><div class="error-message" id="registerConfirmPasswordError">Ошибка</div></div>
                    <button type="submit" class="btn btn-primary" id="registerButton"><i class="fas fa-user-plus"></i> Зарегистрироваться</button>
                </form>
                <div class="toggle-form"><span id="toggleText">Нет аккаунта?</span><a id="toggleLink">Зарегистрироваться</a></div>
            </div>
            <div class="auth-illustration"><h2>SkyMessage</h2><p>Общайтесь с друзьями где угодно</p><i class="fas fa-comment-dots" style="font-size:5rem; opacity:0.8;"></i></div>
        </div>
        <!-- Основной интерфейс -->
        <div class="main-container" id="mainContainer">
            <div class="sidebar">
                <div class="user-info"><div class="user-avatar" id="currentUserAvatar">U</div><div><h3 id="currentUserName">Пользователь</h3><p id="currentUserStatus">online</p></div><button class="btn btn-secondary btn-small" id="logoutButton" style="margin-left:auto;"><i class="fas fa-sign-out-alt"></i></button></div>
                <div class="search-container"><div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchUser" placeholder="Найти пользователя"></div></div>
                <div class="contacts-container" id="contactsContainer"></div>
            </div>
            <div class="chat-container">
                <div class="chat-header"><div class="chat-user-info"><div class="contact-avatar" id="chatUserAvatar">U</div><div><h3 id="chatUserName">Выберите чат</h3><p id="chatUserStatus">начните общение</p></div></div></div>
                <div class="messages-container" id="messagesContainer"><div style="text-align:center; margin-top:50px; color:#6c757d;"><i class="fas fa-comments" style="font-size:3rem; opacity:0.5;"></i><p>Выберите чат</p></div></div>
                <div class="message-input-container"><textarea class="message-input" id="messageInput" placeholder="Сообщение..." disabled></textarea><button class="send-button" id="sendMessageButton" disabled><i class="fas fa-paper-plane"></i></button></div>
            </div>
        </div>
    </div>
    <!-- Уведомление -->
    <div class="notification" id="notification"><div class="notification-icon"><i class="fas fa-bell"></i></div><div><h4 id="notificationTitle">Уведомление</h4><p id="notificationText">Текст</p></div></div>

    <script>
        (function() {
            // ВАШИ ДАННЫЕ SUPABASE (УЖЕ ВСТАВЛЕНЫ)
            const SUPABASE_URL = 'https://fjaauwfxkrnplpefvskk.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_1tMM2yb22UL0MmoJOgV4UA_csjisi7w';

            if (typeof supabase === 'undefined') {
                alert('Ошибка загрузки Supabase. Проверьте интернет.');
                return;
            }
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            let currentUser = null;
            let currentContact = null;
            let userContacts = [];
            let userMessages = {};

            // Вспомогательные функции
            const showError = (id, msg) => {
                const el = document.getElementById(id);
                if (el) { el.textContent = msg; el.style.display = 'block'; }
            };
            const hideError = (id) => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            };
            const showNotification = (title, text) => {
                const n = document.getElementById('notification');
                document.getElementById('notificationTitle').textContent = title;
                document.getElementById('notificationText').textContent = text;
                n.classList.add('show');
                setTimeout(() => n.classList.remove('show'), 3000);
            };
            const getTime = () => new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });

            // Переключение форм
            document.getElementById('toggleLink').addEventListener('click', () => {
                const login = document.getElementById('loginForm');
                const reg = document.getElementById('registerForm');
                const title = document.getElementById('formTitle');
                const toggleText = document.getElementById('toggleText');
                const link = document.getElementById('toggleLink');
                if (login.classList.contains('hidden')) {
                    login.classList.remove('hidden');
                    reg.classList.add('hidden');
                    title.textContent = 'Войдите в аккаунт';
                    toggleText.textContent = 'Нет аккаунта?';
                    link.textContent = 'Зарегистрироваться';
                } else {
                    login.classList.add('hidden');
                    reg.classList.remove('hidden');
                    title.textContent = 'Создайте аккаунт';
                    toggleText.textContent = 'Уже есть аккаунт?';
                    link.textContent = 'Войти';
                }
            });

            // РЕГИСТРАЦИЯ
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value.trim();
                const confirm = document.getElementById('registerConfirmPassword').value.trim();

                hideError('registerUsernameError');
                hideError('registerPasswordError');
                hideError('registerConfirmPasswordError');

                if (password !== confirm) {
                    showError('registerConfirmPasswordError', 'Пароли не совпадают');
                    return;
                }
                if (username.length < 3) {
                    showError('registerUsernameError', 'Минимум 3 символа');
                    return;
                }
                if (password.length < 6) {
                    showError('registerPasswordError', 'Минимум 6 символов');
                    return;
                }

                // Проверка существования пользователя
                const { data: existing } = await supabaseClient
                    .from('users')
                    .select('username')
                    .eq('username', username);

                if (existing && existing.length > 0) {
                    showError('registerUsernameError', 'Имя занято');
                    return;
                }

                // Создание
                const { data, error } = await supabaseClient
                    .from('users')
                    .insert([{
                        username,
                        password,
                        name: username.charAt(0).toUpperCase() + username.slice(1),
                        avatar: username.charAt(0).toUpperCase(),
                        online: true,
                        last_seen: new Date()
                    }])
                    .select();

                if (error) {
                    console.error(error);
                    showError('registerUsernameError', 'Ошибка базы данных. Возможно, не настроены права доступа (RLS).');
                    return;
                }

                currentUser = data[0];
                localStorage.setItem('skyMessageUser', JSON.stringify(currentUser));
                showMainInterface();
                showNotification('Успешно', 'Добро пожаловать!');
            });

            // ВХОД
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value.trim();

                hideError('loginUsernameError');
                hideError('loginPasswordError');

                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password);

                if (error || !data || data.length === 0) {
                    showError('loginUsernameError', 'Неверный логин или пароль');
                    return;
                }

                currentUser = data[0];
                await supabaseClient
                    .from('users')
                    .update({ online: true, last_seen: new Date() })
                    .eq('id', currentUser.id);

                localStorage.setItem('skyMessageUser', JSON.stringify(currentUser));
                showMainInterface();
                showNotification('Успешно', 'С возвращением!');
            });

            // ВЫХОД
            document.getElementById('logoutButton').addEventListener('click', async () => {
                if (currentUser) {
                    await supabaseClient
                        .from('users')
                        .update({ online: false, last_seen: new Date() })
                        .eq('id', currentUser.id);
                }
                currentUser = null;
                localStorage.removeItem('skyMessageUser');
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
            });

            // ЗАГРУЗКА КОНТАКТОВ
            async function loadContacts() {
                if (!currentUser) return;
                const { data } = await supabaseClient
                    .from('contacts')
                    .select('contact_id, users!contacts_contact_id_fkey(id, username, name, avatar, online, last_seen)')
                    .eq('user_id', currentUser.id);
                userContacts = (data || []).map(c => c.users);
                renderContacts();
            }

            // ПОИСК
            let searchTimeout;
            document.getElementById('searchUser').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const q = e.target.value.trim();
                    if (!q || !currentUser) return;
                    const { data } = await supabaseClient
                        .from('users')
                        .select('*')
                        .neq('id', currentUser.id)
                        .or(`username.ilike.%${q}%,name.ilike.%${q}%`);
                    renderSearchResults(data || []);
                }, 300);
            });

            // ДОБАВЛЕНИЕ КОНТАКТА
            async function addToContacts(user) {
                await supabaseClient
                    .from('contacts')
                    .insert([{ user_id: currentUser.id, contact_id: user.id }]);
                userContacts.push(user);
                renderContacts();
                showNotification('Контакт добавлен', user.name);
            }

            // ВЫБОР КОНТАКТА
            async function selectContact(contact) {
                currentContact = contact;
                document.getElementById('chatUserName').textContent = contact.name;
                document.getElementById('chatUserAvatar').textContent = contact.avatar;
                document.getElementById('chatUserStatus').textContent = contact.online ? 'в сети' : 'был(а) недавно';
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendMessageButton').disabled = false;

                const { data } = await supabaseClient
                    .from('messages')
                    .select('*')
                    .or(`and(from_id.eq.${currentUser.id},to_id.eq.${contact.id}),and(from_id.eq.${contact.id},to_id.eq.${currentUser.id})`)
                    .order('created_at');
                userMessages[contact.id] = data || [];
                renderMessages(contact.id);
            }

            // ОТПРАВКА СООБЩЕНИЯ
            async function sendMessage() {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                if (!text || !currentContact) return;
                const time = getTime();
                await supabaseClient
                    .from('messages')
                    .insert([{ from_id: currentUser.id, to_id: currentContact.id, text, time }]);
                input.value = '';
                input.style.height = 'auto';
                // Для простоты добавим в локальный список (без realtime)
                if (!userMessages[currentContact.id]) userMessages[currentContact.id] = [];
                userMessages[currentContact.id].push({
                    id: Date.now(),
                    text,
                    sender: currentUser.id,
                    time,
                    outgoing: true
                });
                renderMessages(currentContact.id);
            }

            // ОТОБРАЖЕНИЕ
            function renderMessages(contactId) {
                const container = document.getElementById('messagesContainer');
                const msgs = userMessages[contactId] || [];
                if (msgs.length === 0) {
                    container.innerHTML = '<div style="text-align:center; margin-top:50px; color:#6c757d;"><i class="fas fa-comment" style="font-size:3rem; opacity:0.5;"></i><p>Начните общение</p></div>';
                    return;
                }
                container.innerHTML = '';
                msgs.forEach(msg => {
                    const el = document.createElement('div');
                    el.className = `message ${msg.outgoing ? 'message-outgoing' : 'message-incoming'}`;
                    el.innerHTML = `<div>${msg.text}</div><div class="message-time">${msg.time}</div>`;
                    container.appendChild(el);
                });
                container.scrollTop = container.scrollHeight;
            }

            function renderContacts() {
                const container = document.getElementById('contactsContainer');
                if (userContacts.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:30px; color:#6c757d;"><i class="fas fa-users" style="font-size:2rem; opacity:0.5;"></i><p>Контактов нет</p><p>Используйте поиск</p></div>';
                    return;
                }
                container.innerHTML = '';
                userContacts.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'contact';
                    el.innerHTML = `
                        <div class="contact-avatar">${c.avatar}</div>
                        <div class="contact-info"><h4>${c.name} @${c.username}</h4><p>${c.online ? 'в сети' : 'был(а) недавно'}</p></div>
                        <div class="contact-status ${c.online ? 'online' : ''}"></div>
                    `;
                    el.addEventListener('click', () => selectContact(c));
                    container.appendChild(el);
                });
            }

            function renderSearchResults(results) {
                const container = document.getElementById('contactsContainer');
                if (results.length === 0) {
                    container.innerHTML = '<div style="text-align:center; padding:30px; color:#6c757d;"><i class="fas fa-search" style="font-size:2rem; opacity:0.5;"></i><p>Ничего не найдено</p></div>';
                    return;
                }
                container.innerHTML = '';
                results.forEach(u => {
                    const isContact = userContacts.some(c => c.id === u.id);
                    const el = document.createElement('div');
                    el.className = 'contact';
                    el.innerHTML = `
                        <div class="contact-avatar">${u.avatar}</div>
                        <div class="contact-info"><h4>${u.name} @${u.username}</h4><p>${u.online ? 'в сети' : 'был(а) недавно'}</p></div>
                        <div class="contact-status ${u.online ? 'online' : ''}"></div>
                        ${!isContact ? '<button class="btn btn-primary btn-small add-contact-btn" style="margin-left:10px;"><i class="fas fa-user-plus"></i></button>' : ''}
                    `;
                    const btn = el.querySelector('.add-contact-btn');
                    if (btn) btn.addEventListener('click', (e) => { e.stopPropagation(); addToContacts(u); });
                    el.addEventListener('click', () => {
                        if (isContact) {
                            const contact = userContacts.find(c => c.id === u.id);
                            if (contact) selectContact(contact);
                        }
                    });
                    container.appendChild(el);
                });
            }

            async function showMainInterface() {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'flex';
                document.getElementById('currentUserName').textContent = currentUser.name;
                document.getElementById('currentUserAvatar').textContent = currentUser.avatar;
                await loadContacts();
            }

            // Проверка авторизации при загрузке
            (async () => {
                const saved = localStorage.getItem('skyMessageUser');
                if (saved) {
                    try {
                        const u = JSON.parse(saved);
                        const { data } = await supabaseClient.from('users').select('*').eq('id', u.id).single();
                        if (data) {
                            currentUser = data;
                            await supabaseClient.from('users').update({ online: true, last_seen: new Date() }).eq('id', currentUser.id);
                            showMainInterface();
                        } else {
                            localStorage.removeItem('skyMessageUser');
                        }
                    } catch { localStorage.removeItem('skyMessageUser'); }
                }
            })();

            // Привязка отправки
            document.getElementById('sendMessageButton').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });
        })();
    </script>
</body>
</html>
