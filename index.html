<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMessage на Supabase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* СТИЛИ ИЗ ПРЕДЫДУЩЕЙ ВЕРСИИ - БЕЗ ИЗМЕНЕНИЙ */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        :root {
            --primary-color: #4361ee;
            --primary-dark: #3a56d4;
            --secondary-color: #7209b7;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --border-color: #e0e0e0;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 1200px;
            height: 90vh;
            background-color: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            display: flex;
            transition: var(--transition);
        }
        .auth-container { display: flex; width: 100%; height: 100%; }
        .auth-form { flex: 1; padding: 40px; display: flex; flex-direction: column; justify-content: center; background-color: white; }
        .auth-illustration { flex: 1; background: linear-gradient(to bottom right, var(--primary-color), var(--secondary-color)); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; color: white; }
        .logo { display: flex; align-items: center; margin-bottom: 30px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; font-size: 1.8rem; }
        .logo-text { font-size: 2rem; font-weight: 700; background: linear-gradient(to right, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .form-title { font-size: 2rem; margin-bottom: 10px; color: var(--dark-color); }
        .form-subtitle { color: var(--gray-color); margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark-color); }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid var(--border-color); border-radius: 10px; font-size: 1rem; transition: var(--transition); }
        .form-input:focus { outline: none; border-color: var(--primary-color); }
        .btn { padding: 14px 20px; border-radius: 10px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; width: 100%; }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background-color: var(--light-color); color: var(--dark-color); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background-color: #e9ecef; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-small { padding: 8px 16px; font-size: 0.9rem; }
        .toggle-form { text-align: center; margin-top: 20px; color: var(--gray-color); }
        .toggle-form a { color: var(--primary-color); text-decoration: none; font-weight: 600; cursor: pointer; }
        .error-message { color: var(--danger-color); font-size: 0.9rem; margin-top: 5px; display: none; }
        .main-container { display: none; width: 100%; height: 100%; }
        .sidebar { width: 350px; background-color: #f8f9fa; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; }
        .user-info { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; background-color: white; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 1.2rem; margin-right: 15px; }
        .user-details h3 { font-size: 1.1rem; margin-bottom: 5px; }
        .user-details p { color: var(--gray-color); font-size: 0.9rem; }
        .search-container { padding: 20px; background-color: white; border-bottom: 1px solid var(--border-color); }
        .search-box { position: relative; }
        .search-box input { width: 100%; padding: 12px 16px 12px 40px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 0.95rem; background-color: #f8f9fa; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--gray-color); }
        .contacts-container { flex: 1; overflow-y: auto; padding: 10px; }
        .contact { display: flex; align-items: center; padding: 15px; border-radius: 10px; cursor: pointer; transition: var(--transition); margin-bottom: 5px; }
        .contact:hover { background-color: #e9ecef; }
        .contact.active { background-color: #e3f2fd; }
        .contact-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #4cc9f0, #4361ee); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; margin-right: 15px; }
        .contact-info h4 { font-size: 1rem; margin-bottom: 5px; }
        .contact-info p { color: var(--gray-color); font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .contact-status { margin-left: auto; width: 10px; height: 10px; border-radius: 50%; background-color: #ccc; }
        .contact-status.online { background-color: #4caf50; }
        .chat-container { flex: 1; display: flex; flex-direction: column; background-color: white; }
        .chat-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; background-color: white; }
        .chat-user-info { display: flex; align-items: center; }
        .chat-header-buttons { display: flex; gap: 10px; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; background-color: #f8f9fa; display: flex; flex-direction: column; }
        .message { max-width: 70%; padding: 12px 16px; border-radius: 18px; margin-bottom: 15px; position: relative; word-wrap: break-word; line-height: 1.4; }
        .message-outgoing { align-self: flex-end; background-color: var(--primary-color); color: white; border-bottom-right-radius: 5px; }
        .message-incoming { align-self: flex-start; background-color: white; color: var(--dark-color); border-bottom-left-radius: 5px; border: 1px solid var(--border-color); }
        .message-time { font-size: 0.75rem; margin-top: 5px; opacity: 0.8; text-align: right; }
        .message-input-container { padding: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px; background-color: white; }
        .message-input { flex: 1; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; resize: none; max-height: 100px; }
        .send-button { width: 50px; height: 50px; border-radius: 50%; background-color: var(--primary-color); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .send-button:hover { background-color: var(--primary-dark); transform: scale(1.05); }
        .call-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .call-info { text-align: center; margin-bottom: 40px; }
        .call-info h2 { font-size: 2.5rem; margin-bottom: 10px; }
        .call-info p { font-size: 1.2rem; opacity: 0.9; }
        .video-container { display: flex; gap: 20px; margin-bottom: 40px; max-width: 1200px; width: 90%; }
        .video-box { flex: 1; border-radius: 10px; overflow: hidden; background-color: #333; position: relative; aspect-ratio: 16/9; }
        .video-box video { width: 100%; height: 100%; object-fit: cover; }
        .video-label { position: absolute; bottom: 15px; left: 15px; background-color: rgba(0, 0, 0, 0.6); padding: 5px 10px; border-radius: 5px; font-size: 0.9rem; }
        .call-controls { display: flex; gap: 20px; margin-top: 20px; }
        .call-button { width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; cursor: pointer; transition: var(--transition); border: none; }
        .call-button.accept { background-color: #4caf50; color: white; }
        .call-button.decline { background-color: #f44336; color: white; }
        .call-button.end { background-color: #f44336; color: white; }
        .call-button.toggle { background-color: #2196f3; color: white; }
        .call-button.toggle.active { background-color: #f44336; }
        .call-button:hover { transform: scale(1.1); }
        .device-selectors { margin-top: 20px; display: flex; gap: 20px; background-color: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; }
        .device-selector { display: flex; flex-direction: column; gap: 5px; }
        .device-selector select { padding: 8px 12px; border-radius: 5px; background-color: #333; color: white; border: none; }
        .notification { position: fixed; bottom: 20px; right: 20px; background-color: white; border-radius: 10px; padding: 15px 20px; box-shadow: var(--shadow); display: flex; align-items: center; gap: 15px; z-index: 100; transform: translateX(150%); transition: transform 0.3s ease; max-width: 350px; }
        .notification.show { transform: translateX(0); }
        .notification-icon { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.2rem; }
        .notification.incoming-call .notification-icon { background-color: var(--primary-color); }
        .notification.message .notification-icon { background-color: var(--success-color); }
        .notification-content h4 { font-size: 1rem; margin-bottom: 5px; }
        .notification-content p { font-size: 0.9rem; color: var(--gray-color); }
        .notification-actions { display: flex; gap: 10px; margin-top: 10px; }
        .loader { display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) {
            .container { height: 95vh; border-radius: 10px; }
            .auth-container { flex-direction: column; }
            .auth-illustration { padding: 20px; order: -1; }
            .auth-illustration h2 { font-size: 1.8rem; }
            .auth-form { padding: 30px 20px; }
            .sidebar { width: 100%; }
            .video-container { flex-direction: column; width: 95%; }
            .call-controls { flex-wrap: wrap; justify-content: center; }
            .device-selectors { flex-direction: column; width: 90%; }
            .message { max-width: 85%; }
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .pulse { animation: pulse 2s infinite; }
        .hidden { display: none !important; }
        .visible { display: flex; }
    </style>
</head>
<body>
    <!-- HTML ПОЛНОСТЬЮ ИЗ ПРЕДЫДУЩЕЙ ВЕРСИИ - БЕЗ ИЗМЕНЕНИЙ -->
    <div class="container" id="appContainer">
        <div class="auth-container" id="authContainer">
            <div class="auth-form">
                <div class="logo"><div class="logo-icon"><i class="fas fa-comments"></i></div><div class="logo-text">SkyMessage</div></div>
                <h2 class="form-title" id="formTitle">Войдите в аккаунт</h2>
                <p class="form-subtitle" id="formSubtitle">Введите свои данные для входа в мессенджер</p>
                <form id="loginForm">
                    <div class="form-group"><label class="form-label" for="loginUsername">Имя пользователя</label><input type="text" class="form-input" id="loginUsername" placeholder="Введите ваш никнейм" required><div class="error-message" id="loginUsernameError">Пользователь не найден</div></div>
                    <div class="form-group"><label class="form-label" for="loginPassword">Пароль</label><input type="password" class="form-input" id="loginPassword" placeholder="Введите ваш пароль" required><div class="error-message" id="loginPasswordError">Неверный пароль</div></div>
                    <button type="submit" class="btn btn-primary" id="loginButton"><i class="fas fa-sign-in-alt"></i> Войти</button>
                </form>
                <form id="registerForm" class="hidden">
                    <div class="form-group"><label class="form-label" for="registerUsername">Имя пользователя</label><input type="text" class="form-input" id="registerUsername" placeholder="Придумайте уникальный никнейм" required minlength="3"><div class="error-message" id="registerUsernameError">Этот никнейм уже занят</div></div>
                    <div class="form-group"><label class="form-label" for="registerPassword">Пароль</label><input type="password" class="form-input" id="registerPassword" placeholder="Придумайте надежный пароль" required minlength="6"><div class="error-message" id="registerPasswordError">Пароль должен содержать минимум 6 символов</div></div>
                    <div class="form-group"><label class="form-label" for="registerConfirmPassword">Подтверждение пароля</label><input type="password" class="form-input" id="registerConfirmPassword" placeholder="Повторите пароль" required><div class="error-message" id="registerConfirmPasswordError">Пароли не совпадают</div></div>
                    <button type="submit" class="btn btn-primary" id="registerButton"><i class="fas fa-user-plus"></i> Зарегистрироваться</button>
                </form>
                <div class="toggle-form"><span id="toggleText">Нет аккаунта?</span><a id="toggleLink">Зарегистрироваться</a></div>
            </div>
            <div class="auth-illustration"><h2>SkyMessage</h2><p>Новый способ общения. Отправляйте сообщения, совершайте видеозвонки и оставайтесь на связи с близкими в любое время и в любом месте.</p><div style="margin-top: 40px; font-size: 5rem; opacity: 0.8;"><i class="fas fa-comment-dots"></i></div></div>
        </div>
        <div class="main-container" id="mainContainer">
            <div class="sidebar">
                <div class="user-info"><div class="user-avatar" id="currentUserAvatar">U</div><div class="user-details"><h3 id="currentUserName">Пользователь</h3><p id="currentUserStatus">online</p></div><button class="btn btn-secondary btn-small" id="logoutButton" style="margin-left: auto;"><i class="fas fa-sign-out-alt"></i></button></div>
                <div class="search-container"><div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchUser" placeholder="Найти пользователя по никнейму"><div class="error-message" id="searchError" style="margin-top: 5px; display: none;"></div></div></div>
                <div class="contacts-container" id="contactsContainer"></div>
            </div>
            <div class="chat-container">
                <div class="chat-header" id="chatHeader"><div class="chat-user-info"><div class="contact-avatar" id="chatUserAvatar">U</div><div><h3 id="chatUserName">Выберите чат</h3><p id="chatUserStatus">начните общение</p></div></div><div class="chat-header-buttons"><button class="btn btn-secondary btn-small" id="voiceCallButton" disabled><i class="fas fa-phone"></i></button><button class="btn btn-secondary btn-small" id="videoCallButton" disabled><i class="fas fa-video"></i></button></div></div>
                <div class="messages-container" id="messagesContainer"><div style="text-align: center; margin-top: 50px; color: var(--gray-color);"><i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i><p>Выберите чат для начала общения</p></div></div>
                <div class="message-input-container"><textarea class="message-input" id="messageInput" placeholder="Введите сообщение..." rows="1" disabled></textarea><button class="send-button" id="sendMessageButton" disabled><i class="fas fa-paper-plane"></i></button></div>
            </div>
        </div>
    </div>
    <div class="call-container" id="callContainer">
        <div class="call-info"><h2 id="callTitle">Входящий видеозвонок</h2><p id="callDescription">Пользователь звонит вам</p></div>
        <div class="video-container"><div class="video-box"><video id="localVideo" autoplay muted></video><div class="video-label">Вы</div></div><div class="video-box"><video id="remoteVideo" autoplay></video><div class="video-label" id="remoteUserName">Собеседник</div></div></div>
        <div class="call-controls"><button class="call-button accept" id="acceptCallButton"><i class="fas fa-phone"></i></button><button class="call-button decline" id="declineCallButton"><i class="fas fa-phone-slash"></i></button><button class="call-button toggle" id="toggleVideoButton"><i class="fas fa-video"></i></button><button class="call-button toggle" id="toggleAudioButton"><i class="fas fa-microphone"></i></button><button class="call-button end hidden" id="endCallButton"><i class="fas fa-phone-slash"></i></button></div>
        <div class="device-selectors"><div class="device-selector"><label for="cameraSelect">Камера:</label><select id="cameraSelect"></select></div><div class="device-selector"><label for="microphoneSelect">Микрофон:</label><select id="microphoneSelect"></select></div></div>
    </div>
    <div class="notification" id="notification"><div class="notification-icon"><i class="fas fa-bell"></i></div><div class="notification-content"><h4 id="notificationTitle">Уведомление</h4><p id="notificationText">Текст уведомления</p><div class="notification-actions" id="notificationActions"></div></div></div>

    <script>
        // ================== НАСТРОЙКИ SUPABASE (ВСТАВЬ СВОИ) ==================
        const SUPABASE_URL = 'https://fjaauwfxkrnplpefvskk.supabase.co';  // Project URL
        const SUPABASE_KEY = 'sb_publishable_1tMM2yb22UL0MmoJOgV4UA_csjisi7w';            // anon public key
        // =====================================================================

        // Инициализация Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Текущий пользователь
        let currentUser = null;
        let currentContact = null;
        let userContacts = [];
        let userMessages = {};
        let messagesSubscription = null;

        // Получение времени
        function getCurrentTime() {
            return new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        }

        // Вспомогательные функции
        function showError(id, msg) { 
            const el = document.getElementById(id); 
            if (el) { el.textContent = msg; el.style.display = 'block'; } 
        }
        function hideError(id) { 
            const el = document.getElementById(id); 
            if (el) el.style.display = 'none'; 
        }
        function showNotification(type, title, text) {
            const n = document.getElementById('notification');
            n.className = `notification ${type}`;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationText').textContent = text;
            n.classList.add('show');
            setTimeout(() => n.classList.remove('show'), 3000);
        }

        // Переключение форм
        document.getElementById('toggleLink').addEventListener('click', () => {
            const login = document.getElementById('loginForm');
            const reg = document.getElementById('registerForm');
            const title = document.getElementById('formTitle');
            const subtitle = document.getElementById('formSubtitle');
            const toggleText = document.getElementById('toggleText');
            const link = document.getElementById('toggleLink');
            
            if (login.classList.contains('hidden')) {
                login.classList.remove('hidden');
                reg.classList.add('hidden');
                title.textContent = 'Войдите в аккаунт';
                subtitle.textContent = 'Введите свои данные для входа в мессенджер';
                toggleText.textContent = 'Нет аккаунта?';
                link.textContent = 'Зарегистрироваться';
            } else {
                login.classList.add('hidden');
                reg.classList.remove('hidden');
                title.textContent = 'Создайте аккаунт';
                subtitle.textContent = 'Зарегистрируйтесь, чтобы начать пользоваться мессенджером';
                toggleText.textContent = 'Уже есть аккаунт?';
                link.textContent = 'Войти';
            }
        });

        // РЕГИСТРАЦИЯ
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const confirm = document.getElementById('registerConfirmPassword').value.trim();

            if (password !== confirm) {
                showError('registerConfirmPasswordError', 'Пароли не совпадают');
                return;
            }

            // Проверяем, есть ли уже такой пользователь
            const { data: existing } = await supabase
                .from('users')
                .select('*')
                .eq('username', username);

            if (existing && existing.length > 0) {
                showError('registerUsernameError', 'Этот никнейм уже занят');
                return;
            }

            // Создаем пользователя
            const { data, error } = await supabase
                .from('users')
                .insert([{
                    username: username,
                    password: password,
                    name: username.charAt(0).toUpperCase() + username.slice(1),
                    avatar: username.charAt(0).toUpperCase(),
                    online: true,
                    last_seen: new Date()
                }])
                .select();

            if (error) {
                showError('registerUsernameError', 'Ошибка регистрации');
                return;
            }

            currentUser = data[0];
            localStorage.setItem('skyMessageUser', JSON.stringify(currentUser));
            showMainInterface();
            showNotification('message', 'Успешно!', 'Добро пожаловать в SkyMessage');
        });

        // ВХОД
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('username', username)
                .eq('password', password);

            if (error || !data || data.length === 0) {
                showError('loginUsernameError', 'Неверный логин или пароль');
                return;
            }

            currentUser = data[0];
            
            // Обновляем статус
            await supabase
                .from('users')
                .update({ online: true, last_seen: new Date() })
                .eq('id', currentUser.id);

            localStorage.setItem('skyMessageUser', JSON.stringify(currentUser));
            showMainInterface();
            showNotification('message', 'Успешно!', 'Добро пожаловать обратно');
        });

        // ВЫХОД
        document.getElementById('logoutButton').addEventListener('click', async () => {
            if (currentUser) {
                await supabase
                    .from('users')
                    .update({ online: false, last_seen: new Date() })
                    .eq('id', currentUser.id);
            }
            if (messagesSubscription) messagesSubscription.unsubscribe();
            currentUser = null;
            localStorage.removeItem('skyMessageUser');
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
        });

        // ЗАГРУЗКА КОНТАКТОВ
        async function loadContacts() {
            if (!currentUser) return;
            
            const { data, error } = await supabase
                .from('contacts')
                .select(`
                    contact_id,
                    users!contacts_contact_id_fkey (
                        id, username, name, avatar, online, last_seen
                    )
                `)
                .eq('user_id', currentUser.id);

            if (data) {
                userContacts = data.map(c => c.users);
                renderContacts();
            }
        }

        // ПОИСК ПОЛЬЗОВАТЕЛЕЙ
        let searchTimeout;
        document.getElementById('searchUser').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const query = e.target.value.trim();
                if (!query || !currentUser) return;

                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .neq('id', currentUser.id)
                    .or(`username.ilike.%${query}%,name.ilike.%${query}%`);

                renderSearchResults(data || []);
            }, 300);
        });

        // ДОБАВЛЕНИЕ КОНТАКТА
        async function addToContacts(user) {
            const { error } = await supabase
                .from('contacts')
                .insert([{
                    user_id: currentUser.id,
                    contact_id: user.id
                }]);

            if (!error) {
                userContacts.push(user);
                renderContacts();
                showNotification('message', 'Контакт добавлен', `${user.name} в ваших контактах`);
            }
        }

        // ВЫБОР КОНТАКТА
        async function selectContact(contact) {
            currentContact = contact;
            
            document.getElementById('chatUserName').textContent = contact.name;
            document.getElementById('chatUserAvatar').textContent = contact.avatar;
            document.getElementById('chatUserStatus').textContent = contact.online ? 'в сети' : 'был(а) недавно';
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessageButton').disabled = false;

            // Загружаем сообщения
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .or(`and(from_id.eq.${currentUser.id},to_id.eq.${contact.id}),and(from_id.eq.${contact.id},to_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });

            userMessages[contact.id] = data || [];
            renderMessages(contact.id);

            // Подписываемся на новые сообщения
            if (messagesSubscription) messagesSubscription.unsubscribe();
            
            messagesSubscription = supabase
                .channel('messages')
                .on('postgres_changes', { 
                    event: 'INSERT', 
                    schema: 'public', 
                    table: 'messages',
                    filter: `or(and(from_id=eq.${currentUser.id},to_id=eq.${contact.id}),and(from_id=eq.${contact.id},to_id=eq.${currentUser.id}))`
                }, payload => {
                    const msg = payload.new;
                    if (!userMessages[contact.id]) userMessages[contact.id] = [];
                    userMessages[contact.id].push({
                        id: msg.id,
                        text: msg.text,
                        sender: msg.from_id,
                        time: msg.time,
                        outgoing: msg.from_id === currentUser.id
                    });
                    renderMessages(contact.id);
                })
                .subscribe();
        }

        // ОТПРАВКА СООБЩЕНИЯ
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !currentContact) return;

            const time = getCurrentTime();
            
            await supabase
                .from('messages')
                .insert([{
                    from_id: currentUser.id,
                    to_id: currentContact.id,
                    text: text,
                    time: time
                }]);

            input.value = '';
            input.style.height = 'auto';
        }

        // ОТОБРАЖЕНИЕ СООБЩЕНИЙ
        function renderMessages(contactId) {
            const container = document.getElementById('messagesContainer');
            const msgs = userMessages[contactId] || [];
            
            if (msgs.length === 0) {
                container.innerHTML = '<div style="text-align: center; margin-top: 50px; color: var(--gray-color);"><i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i><p>Начните общение</p></div>';
                return;
            }

            container.innerHTML = '';
            msgs.forEach(msg => {
                const el = document.createElement('div');
                el.className = `message ${msg.outgoing ? 'message-outgoing' : 'message-incoming'}`;
                el.innerHTML = `<div class="message-text">${msg.text}</div><div class="message-time">${msg.time}</div>`;
                container.appendChild(el);
            });
            container.scrollTop = container.scrollHeight;
        }

        // ОТОБРАЖЕНИЕ КОНТАКТОВ
        function renderContacts() {
            const container = document.getElementById('contactsContainer');
            
            if (userContacts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--gray-color);"><i class="fas fa-users" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i><p>Контактов пока нет</p><p style="font-size: 0.9rem;">Используйте поиск, чтобы найти друзей</p></div>';
                return;
            }

            container.innerHTML = '';
            userContacts.forEach(contact => {
                const el = document.createElement('div');
                el.className = 'contact';
                el.dataset.userId = contact.id;
                el.innerHTML = `
                    <div class="contact-avatar">${contact.avatar}</div>
                    <div class="contact-info">
                        <h4>${contact.name} <span style="color: var(--gray-color); font-size:0.8rem;">@${contact.username}</span></h4>
                        <p>${contact.online ? 'в сети' : 'был(а) недавно'}</p>
                    </div>
                    <div class="contact-status ${contact.online ? 'online' : ''}"></div>
                `;
                el.addEventListener('click', () => selectContact(contact));
                container.appendChild(el);
            });
        }

        // ОТОБРАЖЕНИЕ РЕЗУЛЬТАТОВ ПОИСКА
        function renderSearchResults(results) {
            const container = document.getElementById('contactsContainer');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--gray-color);"><i class="fas fa-search" style="font-size: 2rem; margin-bottom: 15px; opacity: 0.5;"></i><p>Ничего не найдено</p></div>';
                return;
            }

            container.innerHTML = '';
            results.forEach(user => {
                const isContact = userContacts.some(c => c.id === user.id);
                const el = document.createElement('div');
                el.className = 'contact';
                el.innerHTML = `
                    <div class="contact-avatar">${user.avatar}</div>
                    <div class="contact-info">
                        <h4>${user.name} <span style="color: var(--gray-color);">@${user.username}</span></h4>
                        <p>${user.online ? 'в сети' : 'был(а) недавно'}</p>
                    </div>
                    <div class="contact-status ${user.online ? 'online' : ''}"></div>
                    ${!isContact ? '<button class="btn btn-primary btn-small add-contact-btn" style="margin-left:10px;"><i class="fas fa-user-plus"></i></button>' : ''}
                `;
                
                const btn = el.querySelector('.add-contact-btn');
                if (btn) btn.addEventListener('click', (e) => { e.stopPropagation(); addToContacts(user); });
                
                el.addEventListener('click', () => {
                    if (isContact) {
                        const contact = userContacts.find(c => c.id === user.id);
                        if (contact) selectContact(contact);
                    }
                });
                
                container.appendChild(el);
            });
        }

        // ПОКАЗ ГЛАВНОГО ИНТЕРФЕЙСА
        async function showMainInterface() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'flex';
            
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserAvatar').textContent = currentUser.avatar;
            
            await loadContacts();
        }

        // ПРОВЕРКА АВТОРИЗАЦИИ ПРИ ЗАГРУЗКЕ
        (async function() {
            const saved = localStorage.getItem('skyMessageUser');
            if (saved) {
                currentUser = JSON.parse(saved);
                // Проверяем, что пользователь еще существует
                const { data } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (data) {
                    currentUser = data;
                    await supabase
                        .from('users')
                        .update({ online: true, last_seen: new Date() })
                        .eq('id', currentUser.id);
                    showMainInterface();
                } else {
                    localStorage.removeItem('skyMessageUser');
                }
            }
        })();
    </script>
</body>
</html>
